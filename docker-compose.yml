# Kōan Docker Compose — Mounted Binaries Approach
#
# The container mounts host CLI binaries (claude, gh) and their auth state.
# No auth setup needed — inherits the host's authenticated sessions.
#
# Quick start:
#   1. Copy env.docker.example → .env.docker (fill in values)
#   2. Run: ./setup-docker.sh (generates docker-compose.override.yml with project mounts)
#   3. Run: docker compose up --build
#
# Commands:
#   docker compose up                     — Full stack (agent + bridge)
#   docker compose run koan test          — Run test suite
#   docker compose run koan shell         — Interactive shell
#   docker compose run koan agent         — Agent loop only
#   docker compose run koan bridge        — Bridge only

services:
  koan:
    build:
      context: .
      args:
        HOST_UID: ${HOST_UID:-501}
        HOST_GID: ${HOST_GID:-20}
    container_name: koan
    env_file:
      - .env.docker
    environment:
      - KOAN_ROOT=/app
      - PYTHONPATH=/app/koan
    volumes:
      # --- Auth & config (from host) ---
      # Claude config: auth tokens, session state, skills
      - ${HOME}/.claude:/home/koan/.claude

      # GitHub CLI auth
      - ${HOME}/.config/gh:/home/koan/.config/gh:ro

      # Git identity (optional — container has its own default)
      - ${HOME}/.gitconfig:/home/koan/.gitconfig:ro

      # --- Instance state (persistent across restarts) ---
      - ./instance:/app/instance

    # Project repo mounts are generated by setup-docker.sh
    # into docker-compose.override.yml. Example:
    #
    #   volumes:
    #     - /Users/you/workspace/myproject:/Users/you/workspace/myproject
    #
    # The override file keeps this compose file clean and generic.

    restart: unless-stopped

    # Uncomment to expose the dashboard:
    # ports:
    #   - "5001:5001"
